<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Todo App Web Client</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .task-completed {
      text-decoration: line-through;
      color: #9CA3AF;
    }
    .task-overdue {
      color: #EF4444;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div id="app" class="container mx-auto max-w-4xl py-8 px-4">
    <!-- Auth Section -->
    <div id="auth-section" class="mb-8">
      <div class="bg-white rounded-lg shadow p-6 mb-4">
        <h2 class="text-xl font-bold mb-4">Authentication</h2>
        
        <!-- Login Form -->
        <div id="login-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <h3 class="text-lg font-semibold mb-2">Login</h3>
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
              <input type="email" id="login-email" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="email@example.com">
            </div>
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
              <input type="password" id="login-password" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="********">
            </div>
            <button id="login-btn" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Login</button>
          </div>
          
          <!-- Register Form -->
          <div>
            <h3 class="text-lg font-semibold mb-2">Register</h3>
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
              <input type="text" id="register-name" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="John Doe">
            </div>
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
              <input type="email" id="register-email" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="email@example.com">
            </div>
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
              <input type="password" id="register-password" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="********">
            </div>
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1">Confirm Password</label>
              <input type="password" id="register-password-confirm" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="********">
            </div>
            <button id="register-btn" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">Register</button>
          </div>
        </div>
        
        <!-- User Info -->
        <div id="user-info" class="hidden">
          <div class="flex justify-between items-center">
            <div>
              <span class="text-sm text-gray-600">Logged in as: </span>
              <span id="user-name" class="font-semibold"></span>
            </div>
            <button id="logout-btn" class="bg-red-500 text-white px-3 py-1 rounded-md text-sm hover:bg-red-600">Logout</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Tasks Section -->
    <div id="tasks-section" class="hidden">
      <div class="bg-white rounded-lg shadow p-6 mb-4">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold">Tasks</h2>
          <button id="add-task-btn" class="bg-blue-500 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-600">Add Task</button>
        </div>
        
        <!-- Filters -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
            <select id="filter-status" class="w-full px-3 py-2 border border-gray-300 rounded-md">
              <option value="all">All</option>
              <option value="completed">Completed</option>
              <option value="pending">Pending</option>
              <option value="overdue">Overdue</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
            <select id="filter-category" class="w-full px-3 py-2 border border-gray-300 rounded-md">
              <option value="">All Categories</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
            <input type="text" id="filter-search" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Search tasks...">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
            <input type="date" id="filter-due-date" class="w-full px-3 py-2 border border-gray-300 rounded-md">
          </div>
        </div>
        <div class="flex justify-end mb-4">
          <button id="apply-filters-btn" class="bg-blue-500 text-white px-3 py-1 rounded-md text-sm hover:bg-blue-600 mr-2">Apply Filters</button>
          <button id="clear-filters-btn" class="bg-gray-500 text-white px-3 py-1 rounded-md text-sm hover:bg-gray-600">Clear Filters</button>
        </div>
        
        <!-- Task List -->
        <div id="task-list" class="border rounded-md">
          <div id="task-loading" class="p-4 text-center">
            <p>Loading tasks...</p>
          </div>
          <div id="task-empty" class="hidden p-4 text-center">
            <p>No tasks found. Create a new task!</p>
          </div>
          <table id="task-table" class="hidden w-full">
            <thead class="bg-gray-50 border-b">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Due Date</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Priority</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
              </tr>
            </thead>
            <tbody id="task-table-body" class="bg-white divide-y divide-gray-200">
              <!-- Tasks will be inserted here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Task Form Modal -->
    <div id="task-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
      <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md">
        <div class="flex justify-between items-center mb-4">
          <h3 id="task-modal-title" class="text-lg font-semibold">Add New Task</h3>
          <button id="close-modal-btn" class="text-gray-500 hover:text-gray-700">
            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <form id="task-form">
          <input type="hidden" id="task-id">
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">Title <span class="text-red-500">*</span></label>
            <input type="text" id="task-title" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
            <div id="task-title-error" class="text-red-500 text-sm mt-1 hidden"></div>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
            <textarea id="task-description" class="w-full px-3 py-2 border border-gray-300 rounded-md" rows="3"></textarea>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
            <select id="task-category" class="w-full px-3 py-2 border border-gray-300 rounded-md">
              <option value="">Select Category</option>
            </select>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
            <input type="date" id="task-due-date" class="w-full px-3 py-2 border border-gray-300 rounded-md">
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
            <select id="task-priority" class="w-full px-3 py-2 border border-gray-300 rounded-md">
              <option value="low">Low</option>
              <option value="medium">Medium</option>
              <option value="high">High</option>
            </select>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
            <select id="task-status" class="w-full px-3 py-2 border border-gray-300 rounded-md">
              <option value="pending">Pending</option>
              <option value="in_progress">In Progress</option>
              <option value="completed">Completed</option>
            </select>
          </div>
          <div class="flex justify-end gap-2">
            <button type="button" id="task-delete-btn" class="hidden bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600">Delete</button>
            <button type="button" id="task-save-btn" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Save</button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="hidden fixed bottom-4 right-4 bg-gray-800 text-white px-4 py-2 rounded-md shadow-lg">
      <span id="toast-message"></span>
    </div>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const API_URL = 'https://todo.prus.dev/api';
      let token = localStorage.getItem('token');
      let currentUser = null;
      let categories = [];
      let tasks = [];
      
      // DOM Elements
      const authSection = document.getElementById('auth-section');
      const loginForm = document.getElementById('login-form');
      const userInfo = document.getElementById('user-info');
      const userName = document.getElementById('user-name');
      const tasksSection = document.getElementById('tasks-section');
      const taskLoading = document.getElementById('task-loading');
      const taskEmpty = document.getElementById('task-empty');
      const taskTable = document.getElementById('task-table');
      const taskTableBody = document.getElementById('task-table-body');
      const taskModal = document.getElementById('task-modal');
      const taskForm = document.getElementById('task-form');
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toast-message');
      
      // Event Listeners
      document.getElementById('login-btn').addEventListener('click', handleLogin);
      document.getElementById('register-btn').addEventListener('click', handleRegister);
      document.getElementById('logout-btn').addEventListener('click', handleLogout);
      document.getElementById('add-task-btn').addEventListener('click', showAddTaskModal);
      document.getElementById('close-modal-btn').addEventListener('click', closeTaskModal);
      document.getElementById('task-save-btn').addEventListener('click', saveTask);
      document.getElementById('task-delete-btn').addEventListener('click', deleteTask);
      document.getElementById('apply-filters-btn').addEventListener('click', applyFilters);
      document.getElementById('clear-filters-btn').addEventListener('click', clearFilters);
      
      // Check if user is logged in
      init();
      
      // Functions
      async function init() {
        if (token) {
          try {
            await fetchUser();
            await fetchCategories();
            showUserInfo();
            showTasksSection();
            fetchTasks();
          } catch (error) {
            console.error('Init error:', error);
            localStorage.removeItem('token');
            token = null;
          }
        }
      }
      
      async function fetchUser() {
        const response = await fetch(`${API_URL}/user`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Accept': 'application/json'
          }
        });
        
        if (!response.ok) throw new Error('Failed to fetch user');
        
        currentUser = await response.json();
        return currentUser;
      }
      
      function showUserInfo() {
        loginForm.classList.add('hidden');
        userInfo.classList.remove('hidden');
        userName.textContent = currentUser.name;
      }
      
      function showTasksSection() {
        tasksSection.classList.remove('hidden');
      }
      
      async function handleLogin() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        
        if (!email || !password) {
          showToast('Please enter email and password');
          return;
        }
        
        try {
          const response = await fetch(`${API_URL}/login`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify({
              email,
              password,
              device_name: navigator.userAgent
            })
          });
          
          const data = await response.json();
          
          if (!response.ok) {
            throw new Error(data.message || 'Login failed');
          }
          
          token = data.token;
          localStorage.setItem('token', token);
          
          await fetchUser();
          await fetchCategories();
          showUserInfo();
          showTasksSection();
          fetchTasks();
          
          showToast('Logged in successfully');
        } catch (error) {
          console.error('Login error:', error);
          showToast(error.message || 'Login failed');
        }
      }
      
      async function handleRegister() {
        const name = document.getElementById('register-name').value;
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        const passwordConfirm = document.getElementById('register-password-confirm').value;
        
        if (!name || !email || !password || !passwordConfirm) {
          showToast('Please fill in all fields');
          return;
        }
        
        if (password !== passwordConfirm) {
          showToast('Passwords do not match');
          return;
        }
        
        try {
          const response = await fetch(`${API_URL}/register`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify({
              name,
              email,
              password,
              password_confirmation: passwordConfirm,
              device_name: navigator.userAgent
            })
          });
          
          const data = await response.json();
          
          if (!response.ok) {
            throw new Error(data.message || 'Registration failed');
          }
          
          token = data.token;
          localStorage.setItem('token', token);
          
          await fetchUser();
          await fetchCategories();
          showUserInfo();
          showTasksSection();
          fetchTasks();
          
          showToast('Registered successfully');
        } catch (error) {
          console.error('Registration error:', error);
          showToast(error.message || 'Registration failed');
        }
      }
      
      async function handleLogout() {
        try {
          await fetch(`${API_URL}/logout`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Accept': 'application/json'
            }
          });
          
          localStorage.removeItem('token');
          token = null;
          currentUser = null;
          
          loginForm.classList.remove('hidden');
          userInfo.classList.add('hidden');
          tasksSection.classList.add('hidden');
          
          showToast('Logged out successfully');
        } catch (error) {
          console.error('Logout error:', error);
          showToast('Logout failed');
        }
      }
      
      async function fetchCategories() {
        try {
          const response = await fetch(`${API_URL}/categories`, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Accept': 'application/json'
            }
          });
          
          if (!response.ok) {
            throw new Error('Failed to fetch categories');
          }
          
          const data = await response.json();
          categories = data.data || [];
          
          // Populate category dropdowns
          populateCategoryDropdowns();
        } catch (error) {
          console.error('Error fetching categories:', error);
          showToast('Failed to fetch categories');
        }
      }
      
      function populateCategoryDropdowns() {
        const taskCategorySelect = document.getElementById('task-category');
        const filterCategorySelect = document.getElementById('filter-category');
        
        // Clear existing options
        taskCategorySelect.innerHTML = '<option value="">Select Category</option>';
        filterCategorySelect.innerHTML = '<option value="">All Categories</option>';
        
        // Add categories to dropdowns
        categories.forEach(category => {
          const taskOption = document.createElement('option');
          taskOption.value = category.id;
          taskOption.textContent = category.name;
          taskCategorySelect.appendChild(taskOption);
          
          const filterOption = document.createElement('option');
          filterOption.value = category.id;
          filterOption.textContent = category.name;
          filterCategorySelect.appendChild(filterOption);
        });
      }
      
      async function fetchTasks() {
        taskLoading.classList.remove('hidden');
        taskTable.classList.add('hidden');
        taskEmpty.classList.add('hidden');
        
        try {
          // Get filter values
          const status = document.getElementById('filter-status').value;
          const category = document.getElementById('filter-category').value;
          const search = document.getElementById('filter-search').value;
          const dueDate = document.getElementById('filter-due-date').value;
          
          // Build query parameters
          const queryParams = new URLSearchParams();
          if (status && status !== 'all') queryParams.append('status', status);
          if (category) queryParams.append('category', category);
          if (search) queryParams.append('search', search);
          if (dueDate) queryParams.append('due_date', dueDate);
          
          const response = await fetch(`${API_URL}/tasks?${queryParams.toString()}`, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Accept': 'application/json'
            }
          });
          
          if (!response.ok) {
            throw new Error('Failed to fetch tasks');
          }
          
          const data = await response.json();
          tasks = data.data || [];
          
          if (tasks.length === 0) {
            taskEmpty.classList.remove('hidden');
          } else {
            renderTasks();
            taskTable.classList.remove('hidden');
          }
        } catch (error) {
          console.error('Error fetching tasks:', error);
          showToast('Failed to fetch tasks');
        } finally {
          taskLoading.classList.add('hidden');
        }
      }
      
      function renderTasks() {
        taskTableBody.innerHTML = '';
        
        tasks.forEach(task => {
          const tr = document.createElement('tr');
          tr.className = 'hover:bg-gray-50';
          
          // Status (checkbox)
          const statusCell = document.createElement('td');
          statusCell.className = 'px-6 py-4 whitespace-nowrap';
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.checked = task.completed;
          checkbox.className = 'h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded';
          checkbox.addEventListener('change', () => toggleTaskCompletion(task.id, !task.completed));
          statusCell.appendChild(checkbox);
          
          // Title
          const titleCell = document.createElement('td');
          titleCell.className = 'px-6 py-4';
          const titleDiv = document.createElement('div');
          titleDiv.className = 'flex flex-col';
          const titleText = document.createElement('span');
          titleText.className = task.completed ? 'text-sm font-medium text-gray-400 line-through' : 'text-sm font-medium text-gray-900';
          titleText.textContent = task.title;
          titleDiv.appendChild(titleText);
          
          if (task.description) {
            const descText = document.createElement('span');
            descText.className = 'text-sm text-gray-500 truncate max-w-xs';
            descText.textContent = task.description;
            titleDiv.appendChild(descText);
          }
          
          titleCell.appendChild(titleDiv);
          
          // Category
          const categoryCell = document.createElement('td');
          categoryCell.className = 'px-6 py-4 whitespace-nowrap';
          if (task.category) {
            const categorySpan = document.createElement('span');
            categorySpan.className = 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full';
            categorySpan.style.backgroundColor = task.category.color ? task.category.color + '33' : '#9CA3AF33';
            categorySpan.style.color = task.category.color || '#4B5563';
            categorySpan.textContent = task.category.name;
            categoryCell.appendChild(categorySpan);
          } else {
            const noneSpan = document.createElement('span');
            noneSpan.className = 'text-gray-400 text-xs';
            noneSpan.textContent = 'None';
            categoryCell.appendChild(noneSpan);
          }
          
          // Due Date
          const dueDateCell = document.createElement('td');
          dueDateCell.className = 'px-6 py-4 whitespace-nowrap';
          if (task.due_date) {
            const dateSpan = document.createElement('span');
            
            // Check if task is overdue
            const isOverdue = new Date(task.due_date) < new Date() && !task.completed;
            
            dateSpan.className = isOverdue
              ? 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800'
              : 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full text-orange-500';
            
            const formattedDate = new Date(task.due_date).toLocaleDateString('en-US', {
              month: 'short',
              day: 'numeric',
              year: 'numeric'
            });
            
            dateSpan.textContent = formattedDate;
            dueDateCell.appendChild(dateSpan);
          } else {
            const noneSpan = document.createElement('span');
            noneSpan.className = 'text-gray-400 text-xs';
            noneSpan.textContent = 'None';
            dueDateCell.appendChild(noneSpan);
          }
          
          // Priority
          const priorityCell = document.createElement('td');
          priorityCell.className = 'px-6 py-4 whitespace-nowrap';
          const prioritySpan = document.createElement('span');
          
          let priorityClass = '';
          switch (task.priority) {
            case 'high':
              priorityClass = 'bg-red-100 text-red-800';
              break;
            case 'medium':
              priorityClass = 'bg-yellow-100 text-yellow-800';
              break;
            default:
              priorityClass = 'bg-green-100 text-green-800';
          }
          
          prioritySpan.className = `px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${priorityClass}`;
          prioritySpan.textContent = task.priority.charAt(0).toUpperCase() + task.priority.slice(1);
          priorityCell.appendChild(prioritySpan);
          
          // Actions
          const actionsCell = document.createElement('td');
          actionsCell.className = 'px-6 py-4 whitespace-nowrap text-right text-sm font-medium';
          
          const editButton = document.createElement('button');
          editButton.className = 'text-blue-600 hover:text-blue-900 mr-3';
          editButton.textContent = 'Edit';
          editButton.addEventListener('click', () => showEditTaskModal(task));
          
          const deleteButton = document.createElement('button');
          deleteButton.className = 'text-red-600 hover:text-red-900';
          deleteButton.textContent = 'Delete';
          deleteButton.addEventListener('click', () => {
            document.getElementById('task-id').value = task.id;
            deleteTask();
          });
          
          actionsCell.appendChild(editButton);
          actionsCell.appendChild(deleteButton);
          
          // Append all cells to row
          tr.appendChild(statusCell);
          tr.appendChild(titleCell);
          tr.appendChild(categoryCell);
          tr.appendChild(dueDateCell);
          tr.appendChild(priorityCell);
          tr.appendChild(actionsCell);
          
          // Append row to table body
          taskTableBody.appendChild(tr);
        });
      }
      
      async function toggleTaskCompletion(taskId, completed) {
        try {
          const response = await fetch(`${API_URL}/tasks/${taskId}/toggle-complete`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Accept': 'application/json'
            }
          });
          
          if (!response.ok) {
            throw new Error('Failed to toggle task completion');
          }
          
          await fetchTasks(); // Refresh tasks
          showToast('Task status updated');
        } catch (error) {
          console.error('Error toggling task completion:', error);
          showToast('Failed to update task status');
        }
      }
      
      function showAddTaskModal() {
        // Reset form
        taskForm.reset();
        document.getElementById('task-id').value = '';
        document.getElementById('task-title-error').classList.add('hidden');
        document.getElementById('task-modal-title').textContent = 'Add New Task';
        document.getElementById('task-delete-btn').classList.add('hidden');
        
        // Show modal
        taskModal.classList.remove('hidden');
      }
      
      function showEditTaskModal(task) {
        // Populate form
        document.getElementById('task-id').value = task.id;
        document.getElementById('task-title').value = task.title;
        document.getElementById('task-description').value = task.description || '';
        document.getElementById('task-category').value = task.category_id || '';
        document.getElementById('task-due-date').value = task.due_date ? new Date(task.due_date).toISOString().split('T')[0] : '';
        document.getElementById('task-priority').value = task.priority || 'low';
        document.getElementById('task-status').value = task.completed ? 'completed' : 'pending';
        
        document.getElementById('task-title-error').classList.add('hidden');
        document.getElementById('task-modal-title').textContent = 'Edit Task';
        document.getElementById('task-delete-btn').classList.remove('hidden');
        
        // Show modal
        taskModal.classList.remove('hidden');
      }
      
      function closeTaskModal() {
        taskModal.classList.add('hidden');
      }
      
      async function saveTask() {
        const taskId = document.getElementById('task-id').value;
        const title = document.getElementById('task-title').value;
        const description = document.getElementById('task-description').value;
        const categoryId = document.getElementById('task-category').value;
        const dueDate = document.getElementById('task-due-date').value;
        const priority = document.getElementById('task-priority').value;
        const status = document.getElementById('task-status').value;
        
        if (!title) {
          document.getElementById('task-title-error').textContent = 'Title is required';
          document.getElementById('task-title-error').classList.remove('hidden');
          return;
        }
        
        const taskData = {
          title,
          description,
          category_id: categoryId || null,
          due_date: dueDate || null,
          priority,
          completed: status === 'completed'
        };
        
        try {
          let response;
          
          if (taskId) {
            // Update existing task
            response = await fetch(`${API_URL}/tasks/${taskId}`, {
              method: 'PUT',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
                'Accept': 'application/json'
              },
              body: JSON.stringify(taskData)
            });
          } else {
            // Create new task
            response = await fetch(`${API_URL}/tasks`, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
                'Accept': 'application/json'
              },
              body: JSON.stringify(taskData)
            });
          }
          
          if (!response.ok) {
            const data = await response.json();
            
            if (data.errors && data.errors.title) {
              document.getElementById('task-title-error').textContent = data.errors.title[0];
              document.getElementById('task-title-error').classList.remove('hidden');
              return;
            }
            
            throw new Error(data.message || 'Failed to save task');
          }
          
          closeTaskModal();
          await fetchTasks(); // Refresh tasks
          showToast(taskId ? 'Task updated successfully' : 'Task created successfully');
        } catch (error) {
          console.error('Error saving task:', error);
          showToast('Failed to save task');
        }
      }
      
      async function deleteTask() {
        const taskId = document.getElementById('task-id').value;
        
        if (!taskId) return;
        
        try {
          const response = await fetch(`${API_URL}/tasks/${taskId}`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Accept': 'application/json'
            }
          });
          
          if (!response.ok) {
            throw new Error('Failed to delete task');
          }
          
          closeTaskModal();
          await fetchTasks(); // Refresh tasks
          showToast('Task deleted successfully');
        } catch (error) {
          console.error('Error deleting task:', error);
          showToast('Failed to delete task');
        }
      }
      
      function applyFilters() {
        fetchTasks();
      }
      
      function clearFilters() {
        document.getElementById('filter-status').value = 'all';
        document.getElementById('filter-category').value = '';
        document.getElementById('filter-search').value = '';
        document.getElementById('filter-due-date').value = '';
        
        fetchTasks();
      }
      
      function showToast(message) {
        toastMessage.textContent = message;
        toast.classList.remove('hidden');
        
        setTimeout(() => {
          toast.classList.add('hidden');
        }, 3000);
      }
    });
  </script>
</body>
</html> 